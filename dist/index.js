(()=>{var e={9182:(e,t,r)=>{const{get:a}=r(6517),s=r(1017),{createDefaultFolder:n}=r(6687),o=e=>a(process.env,`${e}_PRODUCTION`)?a(process.env,`${e}_PRODUCTION`):"production_env_not_found",d={APP_NAME:"flashcard",API_ROOT:o("APP_BASE_URL"),MONGODB_URL:o("MONGO_URL"),MONGO_USER:o("MONGO_USER"),MONGO_PASSWORD:o("MONGO_PASSWORD"),DB_NAME:process.env.DB_NAME,DEFAULT_LANG_CODE:"uz",PROJECT_ID:1,PORT:process.env.PORT,SECRET:process.env.SALT,DELETE_ALL_FILES_PATH:o("DELETE_ALL_FILES_PATH"),IMAGES_PATH:o("IMAGES_PATH"),CACHE_PATH:s.join("src",o("CACHE_PATH")),DATA_PATH:o("DATA_PATH"),TELEGRAM_BOT_API:o("TELEGRAM_BOT_API"),TELEGRAM_BOT_USERNAME:o("TELEGRAM_BOT_USERNAME"),LIMIT_FOR_UPLOADING_FILE_SIZE_IN_BAYTE:process.env.LIMIT_FOR_UPLOADING_FILE_SIZE_IN_BAYTE||"1048576",TOKEN_TYPE:process.env.TOKEN_TYPE};e.exports=d},8937:(e,t,r)=>{const a=r(9344),s=r(8432),{isNull:n,isEmpty:o,isArray:d,isString:i,get:u,head:c}=r(6517),{UserModel:l}=r(2013),{SmsCodeModel:m}=r(9296),{BotUserModel:g}=r(5572),{LanguageModel:p,LanguageCodeModel:y,LanguageKeysModel:f,LanguageValuesModel:h}=r(3513),{hideFields:w,errorHandling:_,smsCodeGenerator:I,updateFormat:b,getOneFromModelByQuery:E,getDataFromModelByQuery:N,requestLogger:O,responseLogger:$}=r(6687),M=r(9182),{bot:A}=r(7611),{UserDetailedByTagModel:T}=r(9049),D=r(1017).basename(__filename),S=M.SECRET;let v={};const q=({query:e={},Model:t}={})=>E({Model:t,query:e}),L=async e=>{const t={languageCode:e,keyId:{$in:(await f.find()).map((e=>e._id))}};let r=await h.find(t).populate("keyId"),a={};return r.forEach((e=>a[e.keyId.name]=e.value)),v[e]=a,a},k=(e,t)=>i(e)&&e.startsWith("+")?t.status(400).send({error:"send phoneNumber without +"}):i(e)&&12!==e.length?t.status(400).send({error:"length of phoneNumber is 12"}):0,R=async(e,t,r,a,s=!0)=>{const n=await E({Model:m,query:{_id:t,smsCode:r,phoneNumber:e}});return n?n.smsCode!==r?a.status(400).send({error:"confirmation_code_incorrect"}):n.isChecked?a.status(400).send({error:"smsCodeId expired"}):(n.isChecked=s,await n.save(),0):a.status(400).send({error:"smsCode not found"})},C=(e,t)=>({token:a.sign({userId:e,role:t},S,{expiresIn:"5d"}),refreshToken:a.sign({userId:e,role:t},S,{expiresIn:"10d"})}),F=async(e,t)=>{const r=await E({Model:g,query:{phoneNumber:e}});if(!r)return t.status(400).send({error:`Go to telegram bot and register -> ${M.TELEGRAM_BOT_USERNAME}`});const a=await m.find({phoneNumber:e,isChecked:!1,createdAt:{$gte:(new Date).getTime()-36e5}});o(a)||a.forEach((e=>{e.isChecked=!0,e.save()}));const s=I(),n=new m({phoneNumber:e,smsCode:s});return A.sendMessage(r.chatId,`Sizning accountingizga login jarayoni amalga oshirildi, Tasdiqlash kodi: ${s}`),await n.save(),{smsCodeId:n._id}},B=async(e,t,r=!0)=>{try{const{phoneNumber:r}=e.body;if(!r)return t.status(400).send({error:"phoneNumber error"});const a=k(r,t);if(a)return a;const{smsCodeId:s}=await F(r,t);s&&t.send({smsCodeId:s})}catch(e){_(e,B.name,t,D)}},x=async({phoneNumber:e,password:t,confirmPassword:r,firstName:a,lastName:s},n)=>{if(!e)return n.status(400).send({error:"phoneNumber error"});if(t!==r)return n.status(400).send({error:"check password and confirmPassword then try again"});if(o(a))return n.status(400).send({error:"firstName is required"});if(o(s))return n.status(400).send({error:"lastName is required"});const d=k(e,n);return d||(await E({Model:l,query:{phoneNumber:e}})?n.status(400).send({error:"phoneNumber is already exists"}):0)},U=async(e,t)=>{const{phoneNumber:r,password:a,smsCodeId:n,smsCode:d}=e.body;try{const e=k(r,t);if(e)return e;if(!r||!a||o(n))return t.status(400).send({error:"Send phoneNumber, password and smsCodeId"});const i=await l.findOne({phoneNumber:r});if(!i)return t.status(400).send({error:"Login is incorrect"});if(!await s.compare(a,i.password))return t.status(400).send({error:"Password is incorrect"});{const e=await R(r,n,d,t);if(e)return e;const{token:a,refreshToken:s}=C(i._id.toString(),u(i,"role"));t.status(200).send({accessToken:a,refreshToken:s,tokenType:M.TOKEN_TYPE})}}catch(e){_(e,U.name,t,D)}},P=async(e,t)=>{try{const{phoneNumber:r,password:a}=e.body,n=k(r,t);if(n)return n;if(!r||!a)return t.status(400).send({error:"Send phoneNumber and password"});const o=await l.findOne({phoneNumber:r});if(!o)return t.status(400).send({error:"Login is incorrect"});if(!await s.compare(a,o.password))return t.status(400).send({error:"Password is incorrect"});B(e,t,!1)}catch(e){_(e,P.name,t,D)}},j=async(e,t)=>{const{phoneNumber:r,password:a,confirmPassword:n,firstName:o,lastName:d,smsCodeId:i,smsCode:u}=e.body;try{if(!i)return t.status(400).send({error:"smsCodeId is required"});const n=await x(e.body,t);if(n)return n;const c=await R(r,i,u,t);if(c)return c;const m=await g.findOne({phoneNumber:r});if(!m)return t.status(400).send({error:"bot user is not found"});const p=await s.hash(a,S),y=new l({firstName:o,lastName:d,phoneNumber:r,password:p,botUserId:m._id.toString()});await y.save();const f=y._id.valueOf(),h=y.role,{token:w,refreshToken:_}=C(f,h);t.status(200).send({accessToken:w,refreshToken:_,tokenType:M.TOKEN_TYPE})}catch(e){_(e,j.name,t,D)}},H=async(e,t)=>{try{const r=await l.findById(e.user.userId,w());t.send({data:r})}catch(e){_(e,H.name,t,D)}},z=async(e,t)=>{try{const{phoneNumber:r}=e.body,a=k(r,t);if(a)return a;const s=await E({Model:l,query:{phoneNumber:r}});t.send({registered:!n(s)})}catch(e){_(e,z.name,t,D)}},G=async(e,t)=>{try{const{phoneNumber:r}=e.body,a=k(r,t);if(a)return a;if(!await E({Model:l,query:{phoneNumber:r}}))return t.status(400).send({error:"phoneNumber not found"});const{smsCodeId:s}=await F(r,t);s&&t.send({smsCodeId:s})}catch(e){_(e,G.name,t,D)}},Y=async(e,t)=>{try{const{phoneNumber:r,smsCodeId:a,smsCode:n,password:o}=e.body;if(!r)return t.status(400).send({error:"phoneNumber  is required"});if(!o)return t.status(400).send({error:"password is required"});const d=k(r,t);if(d)return d;if(!(r&&n&&a&&o))return t.status(400).send({message:"Send phoneNumber, password, smsCode and smsCodeId"});let i=await E({Model:l,query:{phoneNumber:r}});if(!i)return t.status(400).send({error:"phoneNumber not found"});const u=await R(r,a,n,t);if(u)return u;const c=await s.hash(o,S);i.password=c,i=b({item:i,id:i._id}),await i.save();const{token:m,refreshToken:g}=C(i._id,i.role);t.status(200).send({accessToken:m,refreshToken:g,tokenType:M.TOKEN_TYPE})}catch(e){_(e,Y.name,t,D)}},W=async(e,t)=>{try{const{phoneNumber:r,password:a,firstName:n,lastName:d,role:i="admin"}=e.body;if(o(r)||o(a)||o(n)||o(d))return t.status(400).send({error:"phoneNumber, password, firstName, lastName is required"});if("admin"!==i&&"superadmin"!==i)return t.status(400).send({error:"role is invalid"});if(await l.findOne({phoneNumber:r}))return t.status(400).send({error:"user already has been registered"});const u=await s.hash(a,S),c=new l({firstName:n,lastName:d,phoneNumber:r,password:u,role:i});await c.save(),t.status(200).send({message:"success",data:c})}catch(e){_(e,W.name,t,D)}},J=async(e,t)=>{try{const{id:r}=e.params;if(e.user.userId===r)return t.status(400).send({error:"you can not delete yourseft"});const a=await l.findById(r);return"998915411998"!==u(a,"phoneNumber")&&await a.delete(),t.send({message:"admin has been deleted"})}catch(e){_(e,J.name,t,D)}},V=async(e,t)=>{try{const{code:r,name:a}=e.body;if(o(r)||o(a))return t.status(400).send({error:"code and name is required"});if(await y({code:r}))return t.status(400).send({error:`${r} already exists`});const s=new y({code:r,name:a});await s.save(),t.send(s)}catch(e){_(e,V.name,t,D)}},Q=async(e,t)=>{try{const{lang:r}=e.params;if(!o(v[r]))return t.send(v[r]);const a=await y.find();if(o(a)){const e=new y({name:"uz",code:"uz"}),t=new y({name:"ru",code:"ru"}),r=new y({name:"eng",code:"eng"});await e.save(),await t.save(),await r.save()}await L(r),t.send(v[r])}catch(e){_(e,Q.name,t,D)}},K=async(e,t)=>{try{const{lang:r}=e.params;let a=Object.keys(e.body);if(1!==a.length)return t.status(400).send({error:"body error"});if(a=c(a),await f.findOne({name:a}))return t.send({message:"this key already added"});const s=new f({name:a}),n=await y.find();for(const e of n){const t=new h({value:null,keyId:u(s,"_id","").toString(),languageCode:e.code});await t.save()}await s.save(),await L(r),t.send({message:"success"})}catch(e){_(e,K.name,t,D)}},Z=async(e,t)=>{try{const{code:r,keyId:a,value:s,id:n}=e.body;if(!r||!a)return t.status(400).send({error:"code, keyId, value are required"});if(!await y.findOne({code:r}))return t.status(404).send({error:"Language not found"});const o=await h.findOne({_id:n,code:r,keyId:a});if(!o)return t.status(404).send({error:"value not found"});o.value=s||null,await o.save(),await L(r),t.send({message:"success"})}catch(e){_(e,Z.name,t,D)}},X=async(e,t)=>{try{const e=await y.find(),r=[];if(o(e)){const e=new y({name:"uz",code:"uz"}),t=new y({name:"eng",code:"eng"}),a=new y({name:"ru",code:"ru"});await e.save(),await t.save(),await a.save(),r.push(e,t,a)}t.send({data:o(e)?r:e})}catch(e){_(e,X.name,t,D)}},ee=async(e,t)=>{try{let{search:r,lang:a}=e.query,s=new RegExp(r,"i"),n={};null!=r&&""!=r&&(n={languageCode:a,$or:[{value:{$regex:s}}]}),(await f.find({$or:[{name:{$regex:s}}]})).forEach((e=>{d(n.$or)||(n.$or=[]),n.$or&&n.$or.push({keyId:e})}));const o=await h.find(n).populate("keyId");return t.send({data:o})}catch(e){_(e,ee.name,t,D)}},te=async(e,t)=>{try{const e=await l.find({$or:[{role:"admin"},{role:"superadmin"}]},{password:0});return t.send({data:e})}catch(e){_(e,te.name,t,D)}},re=[{path:"botUserId",select:["-deleted","-updated","-updatedById","-updatedAt","-__v"]}],ae=async(e,t)=>{const r=O(u(e,"user.firstName"),D,ae.name);try{const{tagId:r}=e.params,{count:a,limit:s}=e.query;if(!r)return t.status(400).send({error:"tagId is required"});const n=await q({query:{tagId:r,userId:u(e,"user.userId")},Model:T}),d=(new Date).getTime();if(n)n.numberOfAttempts++,n.numberOfAttemptsDate=d,await n.save();else{const t=new T({tagId:r,userId:u(e,"user.userId"),numberOfAttempts:1,numberOfAttemptsDate:d});await t.save()}t.send({message:"ok"});const i=await l.find().populate(re),c=t=>{let r=`${u(e,"user.firstName")} yangi level ga `;return r+=t?"ko'tarilganingiz bilan tabriklayman "+(o(a)?"":a+"ta so'z o'rgandingiz"):`ko'tarildi${o(a)?"":" va "+a+"ta so'z o'rgandi"}.\n\n Harakat qilish vaqti kelmadimi?`,r};i.forEach((t=>{A.sendMessage(u(t,"botUserId.chatId"),c(t._id.toString()===u(e,"user.userId"))).catch((e=>{console.log(e.message)}))}))}catch(e){_(e,ae.name,t,D)}finally{$(u(e,"user.firstName"),D,ae.name,r)}},se=async(e,t)=>{const{chatId:r}=e.params,a=O(u(e,"user.firstName"),D,se.name);try{const a=await q({query:{chatId:r},Model:g});if(!r)return t.status(404).send({error:"Error"});const s=await q({query:{phoneNumber:u(a,"phoneNumber")},Model:l});if(!s)return t.status(404).send({error:"User not registered"});const n=e.get("Origin");if("http://localhost:3001"===n||"https://card.aslamjon.uz"===n||"https://dev.aslamjon.uz"===n||"https://eada-195-158-9-110.ngrok-free.app"===n){const{token:e,refreshToken:r}=C(s._id.toString(),u(s,"role"));return t.status(200).send({accessToken:e,refreshToken:r,tokenType:M.TOKEN_TYPE})}t.send({})}catch(e){_(e,se.name,t,D)}finally{$(u(e,"user.firstName"),D,se.name,a)}};e.exports={login:U,me:H,createUser:j,checkPhoneNumber:z,getSmsCode:B,forgotPassword:Y,verifyPassword:P,addLanguage:V,getLanguages:Q,setKeyLanguage:K,setValueLanguage:Z,verifyCreatingUser:async(e,t)=>{try{const{phoneNumber:r}=e.body,a=await x(e.body,t);if(a)return a;const{smsCodeId:s}=await F(r,t);s&&t.send({data:{smsCodeId:s}})}catch(e){_(e,x.name,t,D)}},verifyPhoneNumber:G,verifySmsCodeForForgot:async(e,t)=>{try{const{phoneNumber:r,smsCode:a,smsCodeId:s}=e.body,n=await R(r,s,a,t,!1);if(n)return n;t.send({message:"ok"})}catch(e){_(e,verifySmsCode.name,t,D)}},getLanguageCodes:X,getLanguageValueForEditing:async(e,t)=>{try{const{lang:r}=e.params,a=await f.find(),s={languageCode:r};a.forEach((e=>{d(s.$or)||(s.$or=[]),s.$or&&s.$or.push({keyId:e})}));let n=await h.find(s).populate("keyId");t.send({data:n})}catch(e){_(e,getLanguageCodesForEditing.name,t,D)}},searchValues:ee,getAdmins:te,getWithoutAdmins:async(e,t)=>{try{const e=await l.find({$nor:[{role:"admin"},{role:"superadmin"}]},{password:0});return t.send({data:e})}catch(e){_(e,te.name,t,D)}},createAdmin:W,removeAdmin:J,increaseRating:ae,loginWithChatId:se}},513:(e,t,r)=>{const{BotUserModel:a}=r(5572),{bot:s}=r(7611),{errorHandling:n}=r(6687),o=r(1017).basename(__filename),d=async(e,t)=>{try{const e=await a.find();return t.send({data:e})}catch(e){n(e,d.name,t,o)}},i=async(e,t)=>{try{const{comment:r,chatId:a}=e.body;return r&&a?(s.sendMessage(a,r),t.status(200).send({message:"success"})):t.status(400).send({error:"Invalid reply"})}catch(e){n(e,i.name,t,o)}},u=async(e,t)=>{try{let{search:r}=e.query,s=new RegExp(r,"i"),n={};null!=r&&""!=r&&(n={$or:[{fullName:{$regex:s}},{phoneNumber:{$regex:s}}]});const o=await a.find(n);return t.send({data:o})}catch(e){n(e,u.name,t,o)}};e.exports={getUsersOfBot:d,search:u,sendMessage:i}},550:(e,t,r)=>{var a="src/controllers";const s=r(1017),{isEmpty:n,isArray:o,get:d}=r(6517),i=r(7147),{FlashCardModel:u}=r(2970),{deleteFormat:c,errorHandling:l,getOneFromModelByQuery:m,getDataFromModelByQuery:g,updateFormat:p,hideFields:y,saveImgs:f,unlink:h,feildRemover:w,requestLogger:_,responseLogger:I}=r(6687),{TagsModel:b}=r(199),{RatingModel:E}=r(3204),{downloadCambridgeAudio:N}=r(3664),{downloadGoogleAudio:O}=r(6752),$=r(1815),{IMAGES_PATH:M}=r(9182),A=s.basename(__filename),T=({query:e={},Model:t=u}={})=>g({Model:t,query:e}),D=({query:e={},Model:t=u}={})=>m({Model:t,query:e}),S="FlashCard",v=[{path:"tag",select:["-deleted","-updated","-updatedById","-updatedAt","-__v"]}],q={adj:!0,adv:!0,noun:!0,verb:!0,pronoun:!0,preposition:!0,conjunction:!0,interjection:!0},L=async(e,t)=>{const r=_(d(e,"user.firstName"),A,L.name);try{let{front:r,back:a,frontDescription:s,backDescription:n,tagId:o,type:i}=e.body;if(!r||!a)return t.status(400).send({error:"front, back are required"});if(!await D({query:{_id:o},Model:b}))return t.status(404).send({error:"tag is not found"});if(i&&!q[i])return t.status(400).send({error:"type error"});if(await D({query:{front:r,tag:o,type:i,createdById:d(e,"user.userId")}}))return t.status(400).send({error:"This word has already been added"});const c=new u({front:r,back:a,frontDescription:s,backDescription:n,tag:o,type:i,createdById:d(e,"user.userId")});return await c.save(),t.status(200).send({message:`${S} created`,data:w(await c.populate(v))})}catch(e){l(e,L.name,t,A)}finally{I(d(e,"user.firstName"),A,L.name,r)}},k=async(e,t)=>{const r=_(d(e,"user.firstName"),A,k.name);try{let{skip:r,limit:a,tagId:s,type:n="global"}=e.query;const{ids:o}=e.body;if(!s)return t.status(400).send({error:"tagId is required"});let i={tag:s};if(o&&(i={...i,_id:{$in:o}}),"self"!==n&&"global"!==n)return t.status(400).send({error:"type is invalid"});"self"===n&&(i.createdById=d(e,"user.userId"));let c={};if(r&&a){if(r=Number(r),a=Number(a),a>200)return t.status(400).send({error:"limit is invalid"});[c.items,c.count]=await Promise.all([T({query:i}).skip(r).limit(a).populate(v),u.countDocuments({...i,deleted:{$eq:!1}})]);const s=c.items.map((e=>e._id)),n=await T({query:{flashCardId:{$in:s},userId:d(e,"user.userId")},Model:E});return t.send({data:c.items,rating:n,count:c.count})}const l=await T({query:i}).populate(v),m=l.map((e=>e._id)),g=await T({query:{flashCardId:{$in:m},userId:d(e,"user.userId")},Model:E});return t.send({data:l,rating:g})}catch(e){l(e,k.name,t,A)}finally{I(d(e,"user.firstName"),A,k.name,r)}},R=async(e,t)=>{const r=_(d(e,"user.firstName"),A,R.name);try{let{tagId:r}=e.query;const{id:a}=e.params,s=await T({query:{_id:a,tag:r}}).populate(v);return t.send({data:s})}catch(e){l(e,k.name,t,A)}finally{I(d(e,"user.firstName"),A,R.name,r)}},C=async(e,t)=>{const r=_(d(e,"user.firstName"),A,C.name);try{if(!o(e.body))return t.status(400).send({error:"invaild data"});const r=await T({query:{_id:{$in:e.body}}});if(e.body.length!==r.length)return t.status(404).send({error:"ids are not found"});r.forEach((async t=>{await c({item:t,id:e.user.userId}).save()})),t.send({message:`${S} has been deleted`})}catch(e){l(e,C.name,t,A)}finally{I(d(e,"user.firstName"),A,C.name,r)}},F=async(e,t)=>{const r=_(d(e,"user.firstName"),A,F.name);try{const{id:r}=e.params;let{front:a,back:s,frontDescription:o,backDescription:i,type:u}=e.body;if(!r)return t.status(400).send({error:" id are required"});let c={_id:r},l=await D({query:c});return n(l)?t.status(404).send({message:"data not found"}):u&&!q[u]?t.status(400).send({error:"type error"}):l.createdById.toString()!==d(e,"user.userId")?t.status(403).send({error:"not allowed"}):(l.front=a||l.front,l.back=s||l.back,l.frontDescription=o||l.frontDescription,l.backDescription=i||l.backDescription,l.type=u||l.type,l=p({item:l,id:d(e,"user.userId")}),await l.save(),t.send({message:"updated",data:l}))}catch(e){l(e,F.name,t,A)}finally{I(d(e,"user.firstName"),A,F.name,r)}};let B={},x={};const U=async(e,t)=>{const r=_(d(e,"user.firstName"),A,U.name);try{const{word:r}=e.params;if(n(B)){const e=i.readFileSync("data/cambridge.json",{encoding:"ascii"});B=JSON.parse(e)}if(d(B[r],"filePath")){const e=s.join(a,`../../${d(B[r],"filePath")}`);return t.sendFile(e)}if(n(x)){const e=i.readFileSync("data/google.json",{encoding:"ascii"});x=JSON.parse(e)}if(d(x[r],"filePath")){const e=s.join(a,`../../${d(x[r],"filePath")}`);return t.sendFile(e)}$.info(`${r} request -> [getPronunciation.cambridge] -> ${e.method} ${e.originalUrl}`);let o=(new Date).getTime();const u=await N(r,"data/pronunciation/cambridge");if($.info(`${r} response in ${(new Date).getTime()-o}ms <- [getPronunciation.cambridge]: ${JSON.stringify(u)}`),u.downloaded){B[r]=u,i.writeFileSync("data/cambridge.json",JSON.stringify(B,null,2));const e=s.join(a,`../../${d(B[r],"filePath")}`);return t.sendFile(e)}$.info(`${r} request -> [getPronunciation.google] -> ${e.method} ${e.originalUrl}`),o=(new Date).getTime();const c=await O(r,"data/pronunciation/google");if($.info(`${r} response in ${(new Date).getTime()-o}ms <- [getPronunciation.google]: ${JSON.stringify(c)}`),c.downloaded){x[r]=c,i.writeFileSync("data/google.json",JSON.stringify(x,null,2));const e=s.join(a,`../../${d(x[r],"filePath")}`);return t.sendFile(e)}return t.status(404).send({error:"not found"})}catch(e){l(e,U.name,t,A)}finally{I(d(e,"user.firstName"),A,U.name,r)}},P=async(e,t)=>{const r=_(d(e,"user.firstName"),A,P.name);try{const{word:r,type:n}=e.params,o=s.join(a,`../../${M}/${n}/${r}.jpg`);return t.sendFile(o)}catch(e){l(e,P.name,t,A)}finally{I(d(e,"user.firstName"),A,P.name,r)}};e.exports={create:L,getData:k,getOne:R,deleteById:C,updateById:F,getPronunciation:U,getImage:P}},5468:(e,t,r)=>{const a=r(1017),{isEmpty:s,isArray:n,get:o}=r(6517),{RatingModel:d}=r(3204),{deleteFormat:i,errorHandling:u,getOneFromModelByQuery:c,getDataFromModelByQuery:l,updateFormat:m,hideFields:g,saveImgs:p,unlink:y,feildRemover:f,responseLogger:h,requestLogger:w}=r(6687),{TagsModel:_}=r(199),{FlashCardModel:I}=r(2970),{UserDetailedByTagModel:b}=r(9049),E=a.basename(__filename),N=({query:e={},Model:t=d}={})=>l({Model:t,query:e}),O=({query:e={},Model:t=d}={})=>c({Model:t,query:e}),$="Rating",M=[{path:"tag",select:["-deleted","-updated","-updatedById","-updatedAt","-__v"]}],A=async(e,t)=>{try{let{front:r,back:a,frontDescription:s,backDescription:n,tagId:i}=e.body;if(!r||!a)return t.status(400).send({error:"front, back are required"});if(!await O({query:{_id:i},Model:_}))return t.status(404).send({error:"tag is not found"});const u=new d({front:r,back:a,frontDescription:s,backDescription:n,tag:i,createdById:o(e,"user.userId")});return await u.save(),t.status(200).send({message:`${$} created`,data:f(await u.populate(M))})}catch(e){u(e,A.name,t,E)}},T=async(e,t)=>{try{let{skip:r,limit:a}=e.query;const{ids:s}=e.body;let n={};s&&(n={...n,_id:{$in:s}});let o={};if(r&&a&&(r=Number(r),a=Number(a),r<=a))return[o.items,o.count]=await Promise.all([N({query:n}).skip(r).limit(a).populate(M),d.countDocuments({...n,deleted:{$eq:!1}})]),t.send({data:o.items,count:o.count});const i=await N({query:n}).populate(M);return t.send({data:i})}catch(e){u(e,T.name,t,E)}},D=async(e,t)=>{try{if(!n(e.body))return t.status(400).send({error:"invaild data"});const r=await N({query:{_id:{$in:e.body}}});if(e.body.length!==r.length)return t.status(404).send({error:"ids are not found"});r.forEach((async t=>{await i({item:t,id:e.user.userId}).save()})),t.send({message:`${$} has been deleted`})}catch(e){u(e,D.name,t,E)}},S=async(e,t)=>{const r=w(o(e,"user.firstName"),E,S.name);try{const{flashCardId:r}=e.params;let{answer:a,tagId:n}=e.query;if(!r)return t.status(400).send({error:"flashCardId is required"});if(!a)return t.status(400).send({error:"answer is required"});if("correct"!==a&&"incorrect"!==a)return t.status(400).send({error:"answer is not valid"});if(!n)return t.status(400).send({error:"tagId is required"});let i={_id:r},u=await O({query:i,Model:I});if(s(u))return t.status(404).send({error:"flash-card is not found"});let c=await O({query:{flashCardId:r,userId:o(e,"user.userId")}});const l=await O({query:{tagId:n,userId:o(e,"user.userId")},Model:b}),g=3;if(s(c)){const s=new d({flashCardId:r,userId:o(e,"user.userId"),..."correct"===a?{rating:o(l,"numberOfAttempts",0)+1+g,level:1}:"incorrect"===a?{rating:o(l,"numberOfAttempts",0),level:0}:{},createdById:o(e,"user.userId")});return await s.save(),t.send({message:"success"})}return"correct"===a?(c.level++,c.rating+=c.level*g):"incorrect"===a&&(c.level--,c.rating-=c.level*g),c=m({item:c,id:o(e,"user.userId")}),await c.save(),t.send({message:"updated"})}catch(e){u(e,S.name,t,E)}finally{h(o(e,"user.firstName"),E,S.name,r)}};e.exports={create:A,getData:T,getOne:async(e,t)=>{try{let{tagId:r}=e.query;const{id:a}=e.params,s=await N({query:{_id:a,tag:r}}).populate(M);return t.send({data:s})}catch(e){u(e,T.name,t,E)}},deleteById:D,updateById:S}},4733:(e,t,r)=>{const a=r(1017),{isEmpty:s,isArray:n,get:o}=r(6517),{TagsModel:d}=r(199),{deleteFormat:i,errorHandling:u,getOneFromModelByQuery:c,getDataFromModelByQuery:l,updateFormat:m,hideFields:g,saveImgs:p,unlink:y,feildRemover:f,requestLogger:h,responseLogger:w}=r(6687),_=a.basename(__filename),I=({query:e={},Model:t=d}={})=>l({Model:t,query:e}),b=({query:e={},Model:t=d}={})=>c({Model:t,query:e}),E="tag",N=async(e,t)=>{const r=h(o(e,"user.firstName"),_,N.name);try{let{name:r}=e.body;if(!r)return t.status(400).send({error:"name is required"});const a=new d({name:r,createdById:o(e,"user.userId")});return await a.save(),t.status(200).send({message:`${E} created`,data:a})}catch(e){u(e,N.name,t,_)}finally{w(o(e,"user.firstName"),_,N.name,r)}},O=async(e,t)=>{const r=h(o(e,"user.firstName"),_,O.name);try{let{skip:r,limit:a}=e.query;const{ids:s}=e.body;let n={};s&&(n={...n,_id:{$in:s}});let o={};if(r&&a&&(r=Number(r),a=Number(a),r<=a))return[o.items,o.count]=await Promise.all([I({query:n}).skip(r).limit(a),d.countDocuments({...n,deleted:{$eq:!1}})]),t.send({data:o.items,count:o.count});const i=await I({query:n});return t.send({data:i})}catch(e){u(e,O.name,t,_)}finally{w(o(e,"user.firstName"),_,O.name,r)}},$=async(e,t)=>{const r=h(o(e,"user.firstName"),_,$.name);try{const{id:r}=e.params,a=await I({query:{_id:r}});return t.send({data:a})}catch(e){u(e,O.name,t,_)}finally{w(o(e,"user.firstName"),_,$.name,r)}},M=async(e,t)=>{const r=h(o(e,"user.firstName"),_,M.name);try{const{id:r}=e.params;let a={_id:r};if(!r)return t.status(400).send({error:"id is required "});const s=await b({query:a});s?(await i({item:s,id:e.user.userId}).save(),t.send({message:`${E} has been deleted`})):t.status(404).send({error:`${E} is not found`})}catch(e){u(e,M.name,t,_)}finally{w(o(e,"user.firstName"),_,M.name,r)}},A=async(e,t)=>{const r=h(o(e,"user.firstName"),_,A.name);try{const{id:r}=e.params;let{name:a}=e.body;if(!r)return t.status(400).send({error:" id are required"});let n={_id:r},d=await b({query:n});return s(d)?t.status(404).send({message:"data not found"}):(d.name=a||d.name,d=m({item:d,id:o(e,"user.userId")}),await d.save(),t.send({message:"updated",data:d}))}catch(e){u(e,A.name,t,_)}finally{w(o(e,"user.firstName"),_,A.name,r)}};e.exports={create:N,getData:O,getOne:$,deleteById:M,updateById:A}},6418:(e,t,r)=>{const a=r(1017),{UserDetailedByTagModel:s}=r(9049),{errorHandling:n,getDataFromModelByQuery:o,responseLogger:d,requestLogger:i}=r(6687),{get:u}=r(6517),c=a.basename(__filename),l=({query:e={},Model:t=s}={})=>o({Model:t,query:e}),m=async(e,t)=>{const r=i(u(e,"user.firstName"),c,m.name);try{let{skip:r,limit:a}=e.query,n={userId:u(e,"user.userId")},o={};if(r&&a&&(r=Number(r),a=Number(a),r<=a))return[o.items,o.count]=await Promise.all([l({query:n}).skip(r).limit(a),s.countDocuments({...n,deleted:{$eq:!1}})]),t.send({data:o.items,count:o.count});const d=await l({query:n});return t.send({data:d})}catch(e){n(e,m.name,t,c)}finally{d(u(e,"user.firstName"),c,m.name,r)}};e.exports={getData:m}},2288:(e,t,r)=>{const{get:a}=r(6517),s=r(2245),{BotUserModel:n}=r(5572),{UserModel:o}=r(2013),{FlashCardModel:d}=r(2970),{contactOptions:i,homeOptions:u}=r(8750),c=r(9182),{errorHandlerBot:l,requestLogger:m,responseLogger:g}=r(6687),{UserDetailedByTagModel:p}=r(9049),y=r(1017).basename(__filename),f=async(e,t)=>{const r=t.chat.id,s=m(r,y,f.name);try{const t=await n.findOne({chatId:r});if(!t)return e.sendMessage(r,"data not found");const s=await o.findOne({phoneNumber:a(t,"phoneNumber")}),i=await p.find().populate(["userId"]),c={};i.forEach((e=>{c[a(e,"userId._id")]||(c[e.userId._id]={...a(e.userId,"_doc",{}),numberOfAttempts:0}),c[a(e,"userId._id")].numberOfAttempts+=e.numberOfAttempts}));const l=Object.values(c);l.sort(((e,t)=>t.numberOfAttempts-e.numberOfAttempts)),l.length>10&&(l=l.slice(0,10));const m=await d.aggregate([{$group:{_id:"$createdById",count:{$sum:1}}}]),g={};m.forEach((e=>{g[e._id]=e.count}));let y=`ðŸŽ¯ Your rating: ${a(c,`${a(s,"_id")}.numberOfAttempts`)??0}\n\n`,f=0;l.forEach(((e,t)=>{const r=`${0===t?"ðŸ¥‡":1===t?"ðŸ¥ˆ":2===t?"ðŸ¥‰":"ðŸŽ–"} ${e.firstName}: ${e.numberOfAttempts};`;r.length>f&&(f=r.length)})),l.forEach(((e,t)=>{const r=`${0===t?"ðŸ¥‡":1===t?"ðŸ¥ˆ":2===t?"ðŸ¥‰":"ðŸŽ–"} ${e.firstName}: ${e.numberOfAttempts};`.padEnd(f+2);y+=`${r} ${a(g,e._id)?a(g,e._id)+" - ta so'z qo'shgan":""}\n`})),e.sendMessage(r,y,u(r))}catch(e){l(e,f.name,y,t)}finally{g(r,y,f.name,s)}},h=async(e,t)=>{try{const r=t.chat.id;if(!await n.findOne({chatId:r}))return e.sendMessage(r,"data not found");const i=await o.find(),l=await d.aggregate([{$group:{_id:"$tag",count:{$sum:1}}},{$lookup:{from:"tags",localField:"_id",foreignField:"_id",as:"tag"}},{$addFields:{tag:{$arrayElemAt:["$tag",0]}}}]);let m="ðŸ“” So'zlarning tag bo'yicha statistikasi:\n\n";l.forEach((e=>{m+=`âœ ${a(e,"tag.name")}: ${a(e,"count")} ta so'z qo'shilgan\n\n`}));const g=s().clone().subtract(1,"month").endOf("month").toDate(),p=await o.find({$gt:{createdAt:g}});m+=`ðŸ§‘ðŸ»â€ðŸ’» Botdagi obunachilar: ${i.length} ta\n\n`,m+=`ðŸ” Oxirgi 1 oyda â€” ${p.length} ta obunachi qo'shildi\n\n`,m+=`ðŸ“Š ${c.TELEGRAM_BOT_USERNAME} statistikasi`,e.sendMessage(r,m,u(r))}catch(e){l(e,h.name,y,t)}},w=async(e,t)=>{try{const r=t.chat.id,a=await n.findOne({chatId:r});if(!a)return e.sendMessage(r,"data not found");if(!a.isAdmin)return e.sendMessage(r,"you are not allowed");if(t.photo){const r=t.photo.pop();let s=t.caption||"";s.startsWith("/ads")&&(s=s.substr(4)),(await n.find()).forEach((t=>{t._id.toString()!==a._id.toString()&&e.sendPhoto(t.chatId,r.file_id,{caption:s})}))}else if(t.document){let r=t.caption||"";r.startsWith("/ads")&&(r=r.substr(4)),(await n.find()).forEach((s=>{s._id.toString()!==a._id.toString()&&e.sendDocument(s.chatId,t.document.file_id,{caption:r})}))}else if(t.text){let r=t.text||"";r.startsWith("/ads")&&(r=r.substr(4)),(await n.find()).forEach((t=>{t._id.toString()!==a._id.toString()&&e.sendMessage(t.chatId,r)}))}}catch(e){l(e,w.name,y,t)}};e.exports={startCommand:async(e,t)=>{const r=t.chat.id;return await n.findOne({chatId:r})?e.sendMessage(r,`Assalomu aleykum ${t.from.first_name} botga xush kelibsiz.\n  `,u(r)):e.sendMessage(r,`Assalomu aleykum ${t.from.first_name} botga xush kelibsiz.\n  `,i)},infoCommand:async(e,t)=>e.sendMessage(chatId,`sizning ismingiz ${t.from.first_name}`),ratingCommand:f,statisticsCommand:h,showAdsToEveryUsers:w}},7611:(e,t,r)=>{const a=r(3159),{TELEGRAM_BOT_API:s}=r(9182),{startCommand:n,infoCommand:o,ratingCommand:d,statisticsCommand:i,showAdsToEveryUsers:u}=r(2288),{BotUserModel:c}=r(5572),l=r(1017).basename(__filename),m=new a(s,{polling:!0}),{contactOptions:g,locationOption:p,homeOptions:y,removeAllOptions:f,startOpitons:h}=r(8750),{errorHandlerBot:w}=r(6687),{get:_}=r(6517),I={678719517:!0,134099080:!0};m.setMyCommands([{command:"/start",description:"Boshlang'ich uchrashuv"},{command:"/rating",description:"rating"},{command:"/statistics",description:"statistics"}]);const b=async e=>{const t=e.chat.id,r=e.contact.user_id;try{if(t!==r)return m.sendMessage(t,`${e.from.first_name} Iltimos o'zingizni telefon raqamingizni yuboring`);if(e.contact.phone_number.startsWith("+")&&(e.contact.phone_number=_(e,"contact.phone_number","").substr(1)),await c.findOne({phoneNumber:e.contact.phone_number}))return m.sendMessage(t,"Qaytganingiz uchun rahmat. Botni imkonyatlaridan foydalanishingiz mumkin",f);{const r=new c({phoneNumber:_(e,"contact.phone_number",""),fullName:_(e,"contact.first_name","")+_(e,"contact.last_name",""),chatId:t,isAdmin:!!I[t]&&I[t]});return await r.save(),m.sendMessage(t,`Rahmat ${e.from.first_name}`,y(t))}}catch(e){w(e,b.name,l)}},E=async e=>{const t=e.chat.id,r=await c.findOne({chatId:t});r?(r.latitude=e.location.latitude,r.longitude=e.location.longitude,await r.save(),m.sendMessage(t,`Rahmat ${e.from.first_name} endi siz botimizni imkonyatlaridan foydalanishingiz mumkin`,f)):m.sendMessage(t,`${e.from.first_name} start tugmasini bosing`,h)},N=async e=>{const t=e.data,r=e.message.chat.id;if("/again"===t)return startGame(r);console.log("callback_query",t)},O=async e=>{const t=e.text,r=e.chat.id;return"/start"===t?n(m,e):"/rating"===t||"ðŸ“ˆ Rating"===t?d(m,e):"/statistics"===t||"ðŸ“Š Statistics"===t?i(m,e):_(e,"text","").startsWith("/ads")||_(e,"caption","").startsWith("/ads")?u(m,e):(console.log(e),e.contact||e.location||!e.document||_(e,"text","").startsWith("/")?void 0:m.sendMessage(r,"Men bu narsani bilmayman"))},$=async e=>{console.log(e.code)};e.exports={init:()=>{m.on("message",O),m.on("contact",b),m.on("document",(e=>{console.log("document")})),m.on("photo",(e=>{})),m.on("location",E),m.on("callback_query",N),m.on("polling_error",$),m.on("webhook_error",$)},bot:m}},8750:e=>{const t={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Start",callback_data:"/start"}]]})},r=Date.now();e.exports={contactOptions:{parse_mode:"Markdown",reply_markup:{one_time_keyboard:!0,resize_keyboard:!0,keyboard:[[{text:"My phone number",request_contact:!0}]]}},locationOption:{parse_mode:"Markdown",reply_markup:{one_time_keyboard:!0,resize_keyboard:!0,keyboard:[[{text:"My location",request_location:!0}]]}},homeOptions:e=>({reply_markup:JSON.stringify({keyboard:[[{text:"ðŸ“š Learn now",web_app:{url:`https://card.aslamjon.uz?chatId=${e}&timestamp=${r}`}}],[{text:"ðŸ“Š Statistics"},{text:"ðŸ“ˆ Rating"}]],resize_keyboard:!0})}),removeAllOptions:{reply_markup:{remove_keyboard:!0}},startOpitons:t}},1228:(e,t,r)=>{const a=r(9344),s=r(1815),{get:n,isEmpty:o}=r(6517),{UserModel:d}=r(2013),{requestLogger:i,responseLogger:u}=r(6687),c=r(1017).basename(__filename),l={},m=async(e,t,r)=>{const{authorization:g}=e.headers,p=i("none",c,m.name);try{if(g&&g.startsWith("Bearer")){if(token=g.split(" ")[1],!token)return t.status(401).send({error:"Auth error"});let s=a.verify(token,process.env.SALT);e.user=s,t.setHeader("Last-Modified",(new Date).toUTCString());const i=(new Date).getTime(),u=36e5;if(!l[n(e,"user.userId")]&&i-n(l,`${n(e,"user.userId")}.lastUpdateCacheAt`,0)>u){const r=await d.findById(n(e,"user.userId"));if(o(r))return t.status(401).send({error:"Unauthorized"});e.user=Object.assign({},e.user,n(r,"_doc")),l[n(e,"user.userId")]=n(r,"_doc"),l[n(e,"user.userId")].lastUpdateCacheAt=(new Date).getTime()}else l[n(e,"user.userId")]&&(e.user=Object.assign({},e.user,l[n(e,"user.userId")]));r()}else t.status(401).send({error:"Unauthorized"})}catch(e){"TokenExpiredError"===e.name?t.status(401).send({error:"Token expired"}):(s.error(`${e.message} -> ${c} -> ${e} -> ${e.stack}`),t.status(401).send({error:"Auth error"}))}finally{u("none",c,m.name,p)}};e.exports={checkUser:m}},6763:e=>{e.exports={checkPermission:function(e,t,r){const{role:a}=e.user;if("admin"!=a)return t.status(400).send({error:"You can not access here"});r()},isAdmin:function(e,t,r){const{role:a}=e.user;if("admin"!=a&&"superadmin"!==a)return t.send({error:"You can not access here"});r()},isSuperAdmin:function(e,t,r){const{role:a}=e.user;if("superadmin"!=a)return t.status(403).send({error:"You can not access here"});r()}}},5572:(e,t,r)=>{const{Schema:a,model:s}=r(1185),n=new a({phoneNumber:{type:String,required:!0},chatId:{type:String,required:!0},isAdmin:{type:Boolean,default:!1},username:{type:String},fullName:{type:String},latitude:{type:String},longitude:{type:String},createdAt:{type:Date,default:Date.now},deleted:{type:Boolean,default:!1},deletedAt:{type:Date}});e.exports={BotUserModel:s("BotUser",n)}},2970:(e,t,r)=>{const{Schema:a,model:s,Types:n}=r(1185),o=new a({front:{type:String,required:!0},back:{type:String,required:!0},frontDescription:{type:String},backDescription:{type:String},tag:{type:n.ObjectId,ref:"Tags"},type:{type:String},transcription:{type:String},createdAt:{type:Date,default:Date.now},createdById:{type:n.ObjectId,required:!0,ref:"Users"},updated:{type:Boolean,default:!1},updatedAt:{type:Date},updatedById:{type:n.ObjectId,ref:"Users"},deleted:{type:Boolean,default:!1},deleteAt:{type:Date},deletedById:{type:n.ObjectId,ref:"Users"}});e.exports={FlashCardModel:s("FlashCard",o)}},3513:(e,t,r)=>{const{Schema:a,model:s,Types:n}=r(1185),o=new a({name:String}),d=new a({value:{type:String,default:null},keyId:{type:n.ObjectId,required:!0,ref:"Language-keys"},languageCode:{type:String,required:!0}}),i=new a({code:String,name:String,disabled:{type:Boolean,default:!1}});e.exports={LanguageCodeModel:s("Language-code",i),LanguageKeysModel:s("Language-keys",o),LanguageValuesModel:s("Language-values",d)}},3204:(e,t,r)=>{const{Schema:a,model:s,Types:n}=r(1185),o=new a({flashCardId:{type:n.ObjectId,ref:"FlashCard",required:!0},userId:{type:n.ObjectId,ref:"Users",required:!0},rating:{type:Number,default:1},level:{type:Number,default:1},createdAt:{type:Date,default:Date.now},updated:{type:Boolean,default:!1},updatedAt:{type:Date},updatedById:{type:n.ObjectId,ref:"Users"},deleted:{type:Boolean,default:!1},deleteAt:{type:Date},deletedById:{type:n.ObjectId,ref:"Users"}});e.exports={RatingModel:s("Rating",o)}},9296:(e,t,r)=>{const{Schema:a,model:s}=r(1185),n=new a({phoneNumber:{type:String,required:!0},isChecked:{type:Boolean,default:!1},smsCode:{type:String},createdAt:{type:Date,default:Date.now},deleted:{type:Boolean,default:!1},deletedAt:{type:Date}});e.exports={SmsCodeModel:s("SmsCode",n)}},199:(e,t,r)=>{const{Schema:a,model:s,Types:n}=r(1185),o=new a({name:{type:String,required:!0},createdAt:{type:Date,default:Date.now},updated:{type:Boolean,default:!1},updatedAt:{type:Date},updatedById:{type:n.ObjectId,ref:"Users"},deleted:{type:Boolean,default:!1},deleteAt:{type:Date},deletedById:{type:n.ObjectId,ref:"Users"}});e.exports={TagsModel:s("Tags",o)}},7336:(e,t,r)=>{const{Schema:a,model:s,Types:n}=r(1185),o=new a({oldValue:{type:String},newValue:{type:String},controllerName:{type:String},valueId:{type:n.ObjectId},createdById:{type:n.ObjectId,required:!0,ref:"Users"},createdAt:{type:Date,default:Date.now}});e.exports={UpdateModel:s("Update",o)}},9049:(e,t,r)=>{const{Schema:a,model:s,Types:n}=r(1185),o=new a({tagId:{type:n.ObjectId,ref:"Tags",required:!0},userId:{type:n.ObjectId,ref:"Users",required:!0},numberOfAttempts:{type:Number,default:0},numberOfAttemptsDate:{type:Number,default:0},createdAt:{type:Date,default:Date.now},updated:{type:Boolean,default:!1},updatedAt:{type:Date},updatedById:{type:n.ObjectId,ref:"Users"},deleted:{type:Boolean,default:!1},deleteAt:{type:Date},deletedById:{type:n.ObjectId,ref:"Users"}});e.exports={UserDetailedByTagModel:s("UserDetailedByTag",o)}},2013:(e,t,r)=>{const{Schema:a,model:s,Types:n}=r(1185),o=new a({phoneNumber:{type:String,required:!0},password:{type:String,required:!0},firstName:{type:String,default:""},lastName:{type:String,default:""},botUserId:{type:n.ObjectId,ref:"BotUser"},role:{type:String,required:!0,default:"user"},createdAt:{type:Date,default:Date.now},updated:{type:Boolean,default:!1},updatedAt:{type:Date},updatedById:{type:n.ObjectId,ref:"Users"},deleted:{type:Boolean,default:!1},deleteAt:{type:Date},deletedById:{type:n.ObjectId,ref:"Users"}});e.exports={UserModel:s("Users",o)}},6750:(e,t,r)=>{const{Router:a}=r(6860),{login:s,me:n,createUser:o,checkPhoneNumber:d,getSmsCode:i,forgotPassword:u,verifyPassword:c,addLanguage:l,getLanguages:m,setValueLanguage:g,verifyCreatingUser:p,verifyPhoneNumber:y,verifySmsCodeForForgot:f,setKeyLanguage:h,getLanguageCodes:w,getLanguageValueForEditing:_,searchValues:I,getAdmins:b,getWithoutAdmins:E,createAdmin:N,removeAdmin:O,increaseRating:$,loginWithChatId:M}=r(8937),{checkUser:A}=r(1228),{isSuperAdmin:T}=r(6763),D=a();D.post("/v1/auth/sign-in",s),D.get("/v1/auth/me",A,n),D.post("/v1/auth/sign-up",o),D.post("/v1/auth/check-phone",d),D.post("/v1/auth/get-sms-code",i),D.post("/v1/auth/forgot-password",u),D.post("/v1/auth/verify-phone-number",y),D.post("/v1/auth/verify-forgot-sms-code",f),D.post("/v1/auth/verify-password",c),D.post("/v1/auth/verify-creating-user",p),D.post("/v1/auth/create-user",A,T,N),D.delete("/v1/auth/remove-admin/:id",A,T,O),D.post("/v1/language/add-language",A,l),D.get("/v1/language/languages/:lang",m),D.get("/v1/language/get-languages/:lang",_),D.post("/v1/language/set-key/:lang",h),D.post("/v1/language/set-value",g),D.get("/v1/language/codes",w),D.get("/v1/language/search",I),D.get("/v1/admins",b),D.get("/v1/user-without-admin",E),D.get("/v1/play/:tagId",A,$),D.get("/v1/login/:chatId",M),e.exports={authRouter:D}},8222:(e,t,r)=>{const{Router:a}=r(6860),{getUsersOfBot:s,search:n,sendMessage:o}=r(513),{checkUser:d}=r(1228),i=a();i.get("/v1/users-of-bot",s),i.get("/v1/search",n),i.post("/v1/send-message",o),e.exports={botRouter:i}},8312:(e,t,r)=>{const{Router:a}=r(6860),{create:s,getData:n,getOne:o,deleteById:d,updateById:i,getPronunciation:u,getImage:c}=r(550),{checkUser:l}=r(1228),m=a();m.post("/v1",l,s),m.get("/v1",l,n),m.get("/v1/:id",l,o),m.delete("/v1",l,d),m.put("/v1/:id",l,i),m.get("/v1/pronunciation/:word",u),m.get("/v1/image/:type/:word",c),e.exports={flashCardRouter:m}},8855:(e,t,r)=>{const{authRouter:a}=r(6750),{botRouter:s}=r(8222),{flashCardRouter:n}=r(8312),{ratingRouter:o}=r(1302),{tagRouter:d}=r(7165),{userDetailedByTagRouter:i}=r(538);e.exports={userDetailedByTagRouter:i,tagRouter:d,ratingRouter:o,flashCardRouter:n,botRouter:s,authRouter:a}},1302:(e,t,r)=>{const{Router:a}=r(6860),{create:s,getData:n,getOne:o,deleteById:d,updateById:i}=r(5468),{checkUser:u}=r(1228),c=a();c.put("/v1/:flashCardId",i),e.exports={ratingRouter:c}},7165:(e,t,r)=>{const{Router:a}=r(6860),{create:s,getData:n,getOne:o,deleteById:d,updateById:i}=r(4733),u=a();u.post("/v1",s),u.get("/v1",n),u.get("/v1/:id",o),u.delete("/v1/:id",d),u.put("/v1/:id",i),e.exports={tagRouter:u}},538:(e,t,r)=>{const{Router:a}=r(6860),{getData:s}=r(6418),n=a();n.get("/v1",s),e.exports={userDetailedByTagRouter:n}},2533:(e,t,r)=>{const a=r(1185),s=r(8432),{isEmpty:n}=r(6517),o=r(1017),d=r(9182),i=r(1815),{UserModel:u}=r(2013),{LanguageCodeModel:c}=r(3513),{TagsModel:l}=r(199),{errorHandlerBot:m}=r(6687),g=o.basename(__filename),p=async()=>{try{if(!await u.findOne({phoneNumber:"998915411998"})){const e=await s.hash("root25",d.SECRET),t=new u({firstName:"Aslamjon",lastName:"Ibragimov",phoneNumber:"998915411998",password:e,role:"superadmin"});await t.save()}}catch(e){m(e,p.name,g,e.message)}},y=async()=>{try{const e=await c.find();if(n(e)){const e=new c({name:"uz",code:"uz"}),t=new c({name:"eng",code:"eng"}),r=new c({name:"ru",code:"ru"});await e.save(),await t.save(),await r.save()}}catch(e){m(e,y.name,g,e.message)}},f=async()=>{try{const e=await l.find();if(n(e)){const e=new l({name:"eng-uz"});await e.save()}}catch(e){m(e,f.name,g,e.message)}};e.exports={connectDb:async()=>new Promise(((e,t)=>{a.connect(d.MONGODB_URL,{dbName:d.DB_NAME,useNewUrlParser:!0,useUnifiedTopology:!0,auth:{username:d.MONGO_USER,password:d.MONGO_PASSWORD}}).then((async()=>{i.info("Mongodb is connected");try{await p(),await y(),await f(),e()}catch(e){console.log(e)}})).catch((e=>{i.error("err",e),t(e),process.exit(1)}))}))}},5144:(e,t,r)=>{const a=r(2167),s=r(7147),n=r(2781),{promisify:o}=r(3837),d=o(n.finished);e.exports={download:async(e,t)=>{const r=await a({url:e,method:"GET",responseType:"stream"});return new Promise(((e,a)=>{const n=s.createWriteStream(t);r.data.pipe(n),r.data.on("close",(()=>e(d(n)))),r.data.on("error",(e=>a(e)))}))}}},3664:(e,t,r)=>{const a=r(2167),s=r(8048),{get:n}=r(6517),{download:o}=r(5144),{createDefaultFolder:d}=r(6687);e.exports={downloadCambridgeAudio:async(e,t="pronunciation/cambridge")=>{try{const r=await(async(e,t=(()=>""))=>{const r=await a.get(e,{timeout:5e3,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3"}}),n=r.data;if(200===r.status){const e=s.load(n);return t(e),e}})(`https://dictionary.cambridge.org/pronunciation/english/${e}`),i=Array.from(r("#audio2").children()),u=n(i,"[1].attribs.src");d(t);const c=`${t}/${e}.mp3`;return await o("https://dictionary.cambridge.org"+u,c),{downloaded:!0,fileName:`${e}.mp3`,filePath:c,status:200}}catch(e){return{downloaded:!1,status:n(e,"response.status")}}}}},6752:(e,t,r)=>{const{createDefaultFolder:a}=r(6687),{download:s}=r(5144);e.exports={downloadGoogleAudio:async(e,t="pronunciation/google")=>{try{a(t);const r=`${t}/${e=e.toLocaleLowerCase()}.mp3`;return await s(`https://ssl.gstatic.com/dictionary/static/pronunciation/2022-03-02/audio/${e.substring(0,2)}/${e}_en_us_1.mp3`,r),{downloaded:!0,fileName:`${e}.mp3`,filePath:r,status:200}}catch(e){return{downloaded:!1,status:500}}}}},7559:(e,t,r)=>{const a=r(9182),s={SERVER_ERROR:"SERVER_ERROR",YOU_ARE_NOT_ALLOWED:"YOU_ARE_NOT_ALLOWED"},n={SERVER_ERROR:{error:s.SERVER_ERROR},YOU_ARE_NOT_ALLOWED:{error:s.YOU_ARE_NOT_ALLOWED},SEND_FILE_TO_FILE_FEILD:{error:"SEND_FILE_TO_FILE_FEILD"},FILE_SIZE_HAS_EXCEEDED_LIMIT:{error:`FILE_SIZE_HAS_EXCEEDED_LIMIT. File limit ${a.LIMIT_FOR_UPLOADING_FILE_SIZE_IN_BAYTE/1024} kb or ${a.LIMIT_FOR_UPLOADING_FILE_SIZE_IN_BAYTE/1024/1024} mb`},FILE_NOT_DELETED_FROM_CACHE:{error:"file not deleted from cache"},FILE_NOT_RENAMED:{error:"file not renamed"},FILES_NOT_FOUND:{error:"files not found"}},o={SERVER_ERROR:(e,t)=>e.status(500).send({...n.SERVER_ERROR,...t}),YOU_ARE_NOT_ALLOWED:(e,t)=>e.status(400).send({...n.YOU_ARE_NOT_ALLOWED,...t}),SEND_FILE_TO_FILE_FEILD:(e,t)=>e.status(400).send({...n.SEND_FILE_TO_FILE_FEILD,...t}),FILE_SIZE_HAS_EXCEEDED_LIMIT:(e,t)=>e.status(400).send({...n.FILE_SIZE_HAS_EXCEEDED_LIMIT,...t}),FILE_NOT_DELETED_FROM_CACHE:(e,t)=>e.status(500).send({...n.FILE_NOT_DELETED_FROM_CACHE,...t}),FILE_NOT_RENAMED:(e,t)=>e.status(500).send({...n.FILE_NOT_RENAMED,...t}),FILES_NOT_FOUND:(e,t)=>e.status(500).send({...n.FILES_NOT_FOUND,...t}),ONLY_FILE_ALLOWED:(e,t)=>e.status(400).send({error:`Only ${t} files allowed!`})};e.exports={errorMessages:s,errorFormat:n,errors:o,...o}},853:e=>{e.exports={formatDate:function(e,t=new Date,r){let a=["\0","January","February","March","April","May","June","July","August","September","October","November","December"],s=["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],n=["","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],o=["","Sun","Mon","Tue","Wed","Thu","Fri","Sat"];function d(e,t){let r=e+"";for(t=t||2;r.length<t;)r="0"+r;return r}let i=r?t.getUTCFullYear():t.getFullYear();e=(e=(e=e.replace(/(^|[^\\])yyyy+/g,"$1"+i)).replace(/(^|[^\\])yy/g,"$1"+i.toString().substr(2,2))).replace(/(^|[^\\])y/g,"$1"+i);let u=(r?t.getUTCMonth():t.getMonth())+1;e=(e=(e=(e=e.replace(/(^|[^\\])MMMM+/g,"$1"+a[0])).replace(/(^|[^\\])MMM/g,"$1"+s[0])).replace(/(^|[^\\])MM/g,"$1"+d(u))).replace(/(^|[^\\])M/g,"$1"+u);let c=r?t.getUTCDate():t.getDate();e=(e=(e=(e=e.replace(/(^|[^\\])dddd+/g,"$1"+n[0])).replace(/(^|[^\\])ddd/g,"$1"+o[0])).replace(/(^|[^\\])dd/g,"$1"+d(c))).replace(/(^|[^\\])d/g,"$1"+c);let l=r?t.getUTCHours():t.getHours(),m=l>12?l-12:0==l?12:l;e=(e=(e=(e=e.replace(/(^|[^\\])HH+/g,"$1"+d(l))).replace(/(^|[^\\])H/g,"$1"+l)).replace(/(^|[^\\])hh+/g,"$1"+d(m))).replace(/(^|[^\\])h/g,"$1"+m);let g=r?t.getUTCMinutes():t.getMinutes();e=(e=e.replace(/(^|[^\\])mm+/g,"$1"+d(g))).replace(/(^|[^\\])m/g,"$1"+g);let p=r?t.getUTCSeconds():t.getSeconds();e=(e=e.replace(/(^|[^\\])ss+/g,"$1"+d(p))).replace(/(^|[^\\])s/g,"$1"+p);let y=r?t.getUTCMilliseconds():t.getMilliseconds();e=e.replace(/(^|[^\\])fff+/g,"$1"+d(y,3)),y=Math.round(y/10),e=e.replace(/(^|[^\\])ff/g,"$1"+d(y)),y=Math.round(y/10);let f=l<12?"AM":"PM";e=(e=(e=e.replace(/(^|[^\\])f/g,"$1"+y)).replace(/(^|[^\\])TT+/g,"$1"+f)).replace(/(^|[^\\])T/g,"$1"+f.charAt(0));let h=f.toLowerCase();e=(e=e.replace(/(^|[^\\])tt+/g,"$1"+h)).replace(/(^|[^\\])t/g,"$1"+h.charAt(0));let w=-t.getTimezoneOffset(),_=r||!w?"Z":w>0?"+":"-";if(!r){w=Math.abs(w);let e=w%60;_+=d(Math.floor(w/60))+":"+d(e)}e=e.replace(/(^|[^\\])K/g,"$1"+_);let I=(r?t.getUTCDay():t.getDay())+1;return(e=(e=(e=(e=e.replace(new RegExp(n[0],"g"),n[I])).replace(new RegExp(o[0],"g"),o[I])).replace(new RegExp(a[0],"g"),a[u])).replace(new RegExp(s[0],"g"),s[u])).replace(/\\(.)/g,"$1")},ISODate:(e=new Date)=>e.toISOString(),setYear:function(e,t=new Date){let r=(new Date).setFullYear(e);return new Date(r)},getTime:function(e=24,t=new Date){return 24==e?t.toUTCString().split(" ")[4]:t.toLocaleString().split(" ")[1]}}},1815:(e,t,r)=>{const{createLogger:a,transports:s,format:n}=r(7773),{formatDate:o}=r(853),d=a({format:n.combine(n.timestamp(),n.printf((e=>`${o("MM-dd-yyyy HH:mm:ss",new Date(e.timestamp))} - ${e.level.toUpperCase().padEnd(7)} - ${e.message}`))),transports:[new s.Console,new s.File({filename:"app.log"})]});e.exports=d},6687:(e,t,r)=>{const a=r(7147),s=r(1017),{Types:n}=r(1185),{errors:o}=r(7559),{isString:d,isEmpty:i,get:u,isArray:c}=r(6517),l=r(1815),m=r(9182),g=r(2245),p=r(2167),{UpdateModel:y}=r(7336),{errorFormat:f}=r(7559),{download:h}=r(5144),{FlashCardModel:w}=r(2970),_=(e,t)=>{t.status(500).contentType("text/plain").send({message:"Oops! Something went wrong!"})},I=e=>!a.existsSync(e)&&a.mkdirSync(e,{recursive:!0});async function b(e,t,r,a=[".png",".jpeg",".jpg"]){try{if(i(r))throw new Error(f.SEND_FILE_TO_FILE_FEILD.error);if(!(r.size<=m.LIMIT_FOR_UPLOADING_FILE_SIZE_IN_BAYTE))throw new Error(f.FILE_SIZE_HAS_EXCEEDED_LIMIT.error);{const e=r.path;let t=r.originalname;const n=g(),o=n.year(),d=n.format("MMMM"),u=n.date();t=function(e,t="",r=""){const a=g(),s=e.split("."),n=s.pop(),o=a.format("DD-MM-YYYY"),d=a.format("HH.mm.ss.SSS");return s.push(`_${r}_${o}_${d}${t}.${n}`),s.join("")}(t,"");const c=`${o}/${d}/${u}`;let l=`${m.DATA_PATH}/${c}`;I(l);const p=`${l}/${t}`;if(!i(a)&&!a.includes(s.extname(r.originalname).toLowerCase()))throw await N(e)?new Error(`Only ${a.join(", ")} files allowed!`):new Error("file is not deleted from cache");if(!await E(e,p))throw new Error(f.FILE_NOT_RENAMED.error)}return{}}catch(e){throw new Error(`${e.message} from newFileSaver`)}}function E(e,t){return new Promise(((r,s)=>{a.rename(e,t,(e=>{e&&r(0),r(1)}))}))}function N(e){return new Promise(((t,r)=>{a.unlink(e,(e=>{e&&t(0),t(1)}))}))}const O=(e={})=>({deleted:0,deletedAt:0,deletedById:0,updatedById:0,updated:0,__v:0,password:0,...e}),$=()=>(new Date).getTime(),M=({item:e={},id:t})=>(e.updated=!0,e.updatedAt=$(),e.updatedById=n.ObjectId(t),e),A=()=>{let e=Math.floor(1e6*Math.random());return e<1e5?A():e};e.exports={writeData:(e,t)=>{a.writeFile(e,JSON.stringify(t,null,4),"utf8",(e=>{e&&console.log(e)}))},rename:E,unlink:N,saveImg:async function(e,t,r,a=[".png",".jpeg",".jpg"]){try{const n=r.path;let o=r.originalname;o=function(e,t=""){const r=g(),a=e.split("."),s=a.pop(),n=r.format("DD-MM-YYYY"),o=r.format("HH-mm-ss-SSS");return a.push(`__${n}__${o}${t}.${s}`),a.join("")}(o,`__${e.user.userId}`);const d=s.join("src/utils",`${m.IMAGES_PATH}/${o}`);if(a.includes(s.extname(r.originalname).toLowerCase())){if(await E(n,d))return o;_(0,t)}else await N(n)?t.status(403).contentType("text/plain").send({message:`Only ${a.join(", ")} files are allowed!`}):_(0,t)}catch(e){throw new Error(`${e.message} from saveImg`)}},saveImgs:async function(e,t,r=["file"],a=[".pdf",".jpeg",".png",".jpg",".JPG"]){try{if(i(e.files))return e.files=[],{error:`Bad request: please send ${r.join(", ")}`,status:400};if(e.files.length!==r.length){for(let t=0;e.files.length>t;t++)if(!await N(e.files[t].path))return{error:"Oops! Something went wrong!",status:600};return{error:`Bad request: please send ${r.join(", ")}`,status:400}}{let t={};for(let t=0;r.length>t;t++)if(!r.includes(e.files[t].fieldname))return{error:"Bad request",status:400};for(let s=0;r.length>s;s++)t[e.files[s].fieldname]=await b(0,0,e.files[s],a);return t}}catch(e){return{error:e.message,status:400}}},errorHandling:(e,t,a,s)=>{p.post("http://localhost:8083/api/v1/send",{message:`${e.message} -> ${s} -> ${t} -> \n\n ${e.stack}`,url:`http://${a.req.hostname}:${m.PORT}${a.req.originalUrl}`,project:m.APP_NAME,user:a.req.user??a.req.userId}).catch((e=>{})),r(1815).error(`${e.message} -> ${s} -> ${t} -> \n\n ${e.stack}`),o.SERVER_ERROR(a,{message:e.message})},isInt:function(e){return Number(e)===e&&e%1==0},isFloat:function(e){return Number(e)===e&&e%1!=0},toFixed:function(e,t=2){return Number(Number(e).toFixed(t))},encodingBase64:e=>a.readFileSync(e,{encoding:"base64"}),decodingBase64:(e,t)=>{let r=new Buffer.from(e,"base64");a.writeFileSync(t,r)},getTimes:$,hideFields:O,getDataFromModelByQuery:({Model:e,hideFieldQuery:t={},query:r={},withDelete:a=!1})=>e.find(a?r:{...r,deleted:{$eq:!1}},O(t)),getOneFromModelByQuery:({Model:e,hideFieldQuery:t={},query:r={},withDelete:a=!1})=>e.findOne(a?r:{...r,deleted:{$eq:!1}},O(t)),deleteFormat:({item:e={},id:t})=>(e.deleted=!0,e.deletedAt=$(),e.deletedById=n.ObjectId(t),e),updateFormat:M,isLink:e=>!(!d(e)||!e.startsWith("http")&&!e.startsWith("https")),updateModelHandler:async(e,t,r,a)=>{let s=!1;for(const a of e)i(u(r.body,a,"").toString())||`${t[a]}`===u(r.body,a,"").toString()||(s=!0);if(s){const e=new y({oldValue:JSON.stringify(t),newValue:u(r.body),controllerName:a,valueId:t._id,createdById:n.ObjectId(r.user.userId)});await e.save()}return s?M({item:t,id:r.user.userId}):t},smsCodeGenerator:A,errorHandlerBot:(e,t,a,s)=>{p.post("http://localhost:8083/api/v1/send",{message:`${e.message} -> ${a} -> ${t} -> \n\n ${JSON.stringify(s)} -> \n\n ${e.stack}`,url:"none",project:m.APP_NAME,user:"none"}).catch((e=>{})),r(1815).error(`${e.message} -> ${a} -> ${t} -> \n\n ${JSON.stringify(s)} -> \n\n ${e.stack}`)},feildRemover:(e={},t=["__v","deleted","deletedAt","deletedById","updatedById","updated"])=>c(t)?(t.forEach((t=>e[t]=void 0)),e):e,isNum:e=>{e=`${e}`;let t=parseInt(e);return!isNaN(t)&&t.toString()===e},createDefaultFolder:I,isFile:e=>a.existsSync(e)&&a.lstatSync(e).isFile(),requestLogger:(e,t,r)=>Date.now(),responseLogger:(e,t,r,a)=>{l.info(`response: ${e} -> ${t} -> ${r} -> in ${Date.now()-a}ms`)}}},2167:e=>{"use strict";e.exports=require("axios")},8432:e=>{"use strict";e.exports=require("bcryptjs")},8048:e=>{"use strict";e.exports=require("cheerio")},7455:e=>{"use strict";e.exports=require("compression")},3582:e=>{"use strict";e.exports=require("cors")},5142:e=>{"use strict";e.exports=require("dotenv")},6860:e=>{"use strict";e.exports=require("express")},6985:e=>{"use strict";e.exports=require("express-rate-limit")},9344:e=>{"use strict";e.exports=require("jsonwebtoken")},6517:e=>{"use strict";e.exports=require("lodash")},2245:e=>{"use strict";e.exports=require("moment")},1185:e=>{"use strict";e.exports=require("mongoose")},3159:e=>{"use strict";e.exports=require("node-telegram-bot-api")},7773:e=>{"use strict";e.exports=require("winston")},7147:e=>{"use strict";e.exports=require("fs")},1017:e=>{"use strict";e.exports=require("path")},2781:e=>{"use strict";e.exports=require("stream")},3837:e=>{"use strict";e.exports=require("util")}},t={};function r(a){var s=t[a];if(void 0!==s)return s.exports;var n=t[a]={exports:{}};return e[a](n,n.exports,r),n.exports}(()=>{const e=r(6860),t=r(3582),a=r(1017),s=r(7455);r(5142).config();const n=r(1815),o=r(6985),{connectDb:d}=r(2533),{checkUser:i}=r(1228),u=r(9182),{init:c}=r(7611),{flashCardRouter:l,tagRouter:m,ratingRouter:g,userDetailedByTagRouter:p,authRouter:y}=r(8855),{createDefaultFolder:f}=r(6687);f(u.DATA_PATH);const h=e(),w=o({windowMs:1e3,max:20,standardHeaders:!0,legacyHeaders:!1});h.use(t({allowedHeaders:["Content-Type","Authorization","Content-Length","withCredentials","credential","credentials","Timezone"],methods:["GET","PUT","POST","DELETE","OPTIONS","PATCH"],maxAge:7200})),h.use("/api",w),h.use(s({filter:function(e,t){return!e.headers["x-no-compression"]&&s.filter(e,t)}})),h.use(e.urlencoded({limit:"500mb",extended:!0})),h.use(e.json({limit:"500mb",extended:!0})),h.use("/api/auth",y),h.use("/api/flash-card",l),h.use("/api/tag",i,m),h.use("/api/rating",i,g),h.use("/api/user-detailed",i,p),h.get("/ip",((e,t)=>t.send(e.ip))),h.use("/",e.static(a.join("src","./public"))),h.use(e.static("routes")),h.use((async(e,t,r)=>{try{throw new Error("API Not Found. Please check it and try again.")}catch(t){t.status=404,console.log(t.message,t.status,e.method,e.originalUrl),r(t)}})),h.use(((e,t,r,a)=>{404!==e.status&&n.error(`\n  [Global error middleware] \n  ${e.message} \n  ${e.status} \n  ${t.method} \n  ${t.url} \n  ${e.stack} `),r.status(e.status?e.status:500).send({error:e.message}),a()}));const _=u.PORT||3e3;h.listen(_,(async()=>{console.log(`Server is running on ${_}`),await d(),c()}))})()})();